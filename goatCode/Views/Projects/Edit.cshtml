@model goatCode.Models.ViewModels.FileEditViewModel
@using goatCode.Services
@{
    ViewBag.Title = "Edit";
}
@using (Html.BeginForm("SaveCode", "Projects", FormMethod.Post))
{
    @Html.HiddenFor(m => m.content, new { @id = "hidden_editor" })
    @Html.HiddenFor(x => x.ID, new { @id = "hidden_editor" })
    @Html.HiddenFor(t => t.extension, new { @id = "hidden_editor" })
    @Html.HiddenFor(c => c.name, new { @id = "hidden_editor" })
    <input type="submit" value="Save code" />
}


<pre id="editor">
    @Model.content
</pre>
<div id="Editor">
@section scripts
{
    <script src="~/Scripts/ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="~/Scripts/jquery.signalR-2.2.2.js"></script>
    <script src="~/signalr/hubs"></script>
    <script src="http://localhost:8080/signalr/hubs"></script>
    <script>
        $.connection.hub.url = "http://localhost:8080/signalr";
        var DocumentID = @ViewBag.DocumentID;

        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/twilight");
        editor.session.setMode("@("ace/mode/" + Model.extensionSetting())"); // TODO: setja inn gildi eftir modeli
        editor.setPrintMarginColumn(false);

        $("form").submit(function () {
        $("#hidden_editor").val(editor.getSession().getValue());
        });

        var codeHub = $.connection.codeHub;
        var silent = false;
        codeHub.client.onChange = function (changeData) {
            console.log(changeData);
            silent = true;
            editor.getSession().getDocument().applyDelta(changeData);
            silent = false;

        };

        $.connection.hub.start().done(function () {

            codeHub.server.joinDocument(DocumentID);

            editor.on("change", function (obj) {
                if (silent) {
                    return;
                }
                
                console.log(obj);
                codeHub.server.onChange(obj, DocumentID);
            });
        });
         /*jQuery(function savee() {
                setTimeout(function () {
                jQuery('#saveCode').click();
                }, 10000)
          });*/
        //TODO: gera ajax drasl svo þetta sé ekki alltaf að refresha bitch.

    </script>
 }
</div>

